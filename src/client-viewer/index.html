<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deskreen CE Viewer</title>
    <!-- GA tag ID will be loaded dynamically after user consent -->
    <meta name="ga-tag-id" content="%VITE_CLIENT_VIEWER_GA_TAG%" />
    <meta name="client-viewer-version" content="%VITE_CLIENT_VIEWER_VERSION%" />
    <!-- GA request interceptor - blocks requests until user consent -->
    <script>
      (function() {
        const CONSENT_KEY = 'deskreen_ga_consent';
        const GA_DOMAINS = ['google-analytics.com', 'googletagmanager.com', 'google-analytics.co', 'analytics.google.com'];
        
        for (let i = 1; i <= 20; i++) {
          GA_DOMAINS.push('region' + i + '.google-analytics.com');
        }
        
        function getConsentStatus() {
          try {
            const stored = localStorage.getItem(CONSENT_KEY);
            return stored === 'accepted' ? 'accepted' : null;
          } catch {
            return null;
          }
        }
        
        function isGoogleAnalyticsUrl(url) {
          try {
            const urlObj = new URL(url, window.location.href);
            const hostname = urlObj.hostname.toLowerCase();
            return GA_DOMAINS.some(function(domain) {
              return hostname === domain || hostname.endsWith('.' + domain);
            });
          } catch {
            return false;
          }
        }
        
        function shouldBlockRequest() {
          return getConsentStatus() !== 'accepted';
        }
        
        // intercept fetch
        if (window.fetch) {
          const originalFetch = window.fetch;
          window.fetch = function(input, init) {
            const url = typeof input === 'string' ? input : (input instanceof Request ? input.url : '');
            if (isGoogleAnalyticsUrl(url) && shouldBlockRequest()) {
              return Promise.reject(new Error('Google Analytics request blocked: user consent not granted'));
            }
            return originalFetch.apply(this, arguments);
          };
        }
        
        // intercept XMLHttpRequest
        if (window.XMLHttpRequest) {
          const XHR = window.XMLHttpRequest;
          const originalOpen = XHR.prototype.open;
          const originalSend = XHR.prototype.send;
          
          XHR.prototype.open = function(method, url, async, username, password) {
            const urlString = typeof url === 'string' ? url : url.toString();
            if (isGoogleAnalyticsUrl(urlString) && shouldBlockRequest()) {
              throw new Error('Google Analytics request blocked: user consent not granted');
            }
            this._interceptedUrl = urlString;
            return originalOpen.call(this, method, url, async, username, password);
          };
          
          XHR.prototype.send = function() {
            const url = this._interceptedUrl || '';
            if (isGoogleAnalyticsUrl(url) && shouldBlockRequest()) {
              return;
            }
            return originalSend.apply(this, arguments);
          };
        }
        
        // intercept sendBeacon
        if (navigator.sendBeacon) {
          const originalSendBeacon = navigator.sendBeacon;
          navigator.sendBeacon = function(url, data) {
            const urlString = typeof url === 'string' ? url : url.toString();
            if (isGoogleAnalyticsUrl(urlString) && shouldBlockRequest()) {
              return false;
            }
            return originalSendBeacon.call(this, url, data);
          };
        }
      })();
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=%VITE_CLIENT_VIEWER_GA_TAG%"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // set default consent to denied (will be updated when user accepts)
      gtag('consent', 'default', {
        analytics_storage: 'denied',
        ad_storage: 'denied'
      });
      gtag('config', '%VITE_CLIENT_VIEWER_GA_TAG%');
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
